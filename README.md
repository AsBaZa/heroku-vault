# Heroku-Vault

This repository contains a minimal setup for deploying [HashiCorp Vault](https://vaultproject.io/) to [Heroku](https://www.heroku.com/). It uses [Terraform](https://www.terraform.io/) to provision and configure a single instance of a Vault server to run on a free Heroku dyno.

This deployment of Vault uses a [Heroku Postgres](https://www.heroku.com/postgres) instance as its backing storage and [K/V Version 2](https://www.vaultproject.io/docs/secrets/kv/kv-v2) as its default secrets engine. It also includes [auto-unsealing](https://www.vaultproject.io/docs/concepts/seal#auto-unseal) as a feature, but only initializes Vault with a single key share of the master key, which is used for unsealing Vault whenever the server restarts. See [`src/scripts/unseal.sh`](src/scripts/unseal.sh) for more information on how this works.

**This setup is not meant to be a production-ready deployment of Vault** - it should only be used if you want to get Vault up and running in the shortest amount of time for basic or personal use cases.

## Usage

#### Requirements

- [`terraform v0.14+`](https://www.terraform.io/downloads.html)
- [`vault v1.6.1+`](https://www.vaultproject.io/downloads)
- [`docker v19.03+`](https://docs.docker.com/engine/install/)
- [`docker-compose v1.25.5+`](https://docs.docker.com/compose/install/)

You will also need a Heroku account and an associated [API key](https://devcenter.heroku.com/articles/platform-api-quickstart#authentication) for interacting with the Heroku API.

#### Deploy to Heroku

1. Change into the [`terraform/deployment`](terraform/deployment) directory:

   ```shell
   # from root of repository
   cd terraform/deployment
   ```

2. Set the following environment variables required by the Terraform [Heroku Provider](https://registry.terraform.io/providers/heroku/heroku/latest/docs):

   ```shell
   export HEROKU_EMAIL=<the email associated with your Heroku account>
   export HEROKU_API_KEY=<the API key associated with your Heroku account>
   ```

3. Create a `terraform.tfvars` file with the following variables:

   ```
   # terraform/deployment/terraform.tfvars
   heroku_app = <name of the Heroku app>
   heroku_domain = <an optional custom domain for the Heroku app>
   ```

4. Provision the Heroku resources and deploy the [`terraform/deployment/heroku-vault.tar.gz`](terraform/deployment/heroku-vault.tar.gz) build (generated from [`src`](src)) to the newly created Heroku app:

   ```shell
   terraform apply
   ```

#### Initialize Vault

1. Set the `VAULT_ADDR` environment variable to the `heroku_app_url` provided in the output of `terraform apply`:

   ```shell
   export VAULT_ADDR=<the URL of the Heroku app>
   ```

2. Initialize Vault using a single key share:

   ```shell
   vault operator init -key-shares 1 -key-threshold 1
   ```

   **You should store the initial root token and unseal key provided in the output of `vault operator init` somewhere secure for future use.**

3. Set the `VAULT_TOKEN` environment variable to the initial root token, to be used in subsequent `vault` commands:

   ```shell
   export VAULT_TOKEN=<the initial root token generated by Vault>
   ```

4. Add the following variable to your `terraform.tfvars` file:

   ```
   # terraform/deployment/terraform.tfvars
   vault_unseal_key = <the unseal key generated by Vault>
   ```

5. Redeploy Vault with this unseal key to enable auto-unsealing on future restarts:

   ```shell
   terraform apply
   ```

6. Vault should now be unsealed, allowing you to login.

#### Configure Vault

The default configuration for Vault can be found in [`terraform/configuration/main.tf`](terraform/configuration/main.tf).

Features:

- Enables the [`file`](https://www.vaultproject.io/docs/audit/file) audit device.
- Enables the [`userpass`](https://www.vaultproject.io/docs/auth/userpass) and [`github`](https://www.vaultproject.io/docs/auth/github) auth methods.
- Mounts the [`kv-v2`](https://www.vaultproject.io/docs/secrets/kv/kv-v2) secrets engine at a given path.
- Defines an [`admin`](terraform/configuration/policies/admin.tmpl) policy that grants admin access to secrets under the given mount path.

To apply these configurations:

1. Change into the [`terraform/configuration`](terraform/configuration) directory:

   ```shell
   # from root of repository
   cd terraform/configuration
   ```

2. Ensure the following environment variables are set as required by the Terraform [Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs):

   ```shell
   export VAULT_ADDR=<the URL of the Heroku app>
   export VAULT_TOKEN=<the initial root token generated by Vault>
   ```

3. Create a `terraform.tfvars` file with the following variables:

   ```
   # terraform/configuration/terraform.tfvars
   mount_path          = <an optional mount path for the default secrets engine (default: "secret")>
   github_organisation = <an optional GitHub organisation used for authenticating against Vault (default: "")>
   ```

4. Configure the Vault server:

   ```shell
   terraform apply
   ```

## Authentication

#### Userpass

To create a new user under the `userpass` auth method:

```
vault write auth/userpass/users/<username> password=<password> policies=admin
```

You should now be able to access Vault using this username and password; this user will be granted the `admin` policy. To define a different set of policies for the user, provide a comma-separated list of policy names to the `policies` argument.

#### GitHub

If a GitHub organisation was provided for the `github` auth method, users belonging to this organisation should be able to access Vault via a GitHub [personal access token](https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token) with the `read:org` scope.

This user will be granted the `admin` policy, unless defined otherwise in the `token_policies` attribute of the `vault_github_auth_backend.github` resource found in `terraform/configuration/main.tf`.

## Development

If you wish to tailor the setup to your own needs, have a look at the files in [`src/scripts`](src/scripts) and [`terraform`](terraform) and modify them accordingly.

A Docker Compose setup is provided to facilitate local testing of the files in `src/scripts` and `terraform/configuration`. To run the Docker Compose environment:

```shell
docker-compose up
```

If you have made any changes to the `src` folder, remember to regenerate `terraform/deployment/heroku-vault.tar.gz` before deploying Vault. You can use the given [Makefile](Makefile) for this:

```shell
make terraform/deployment/heroku-vault.tar.gz
```
